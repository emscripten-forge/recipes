context:
  version: 23.0.0
  name: arrow

build:
  number: 4

cache:
  source:
    - url: https://github.com/apache/arrow/releases/download/apache-arrow-${{ version }}/apache-arrow-${{ version }}.tar.gz
      sha256: 12f6844a0ba3b99645cd2bc6cc4f44f6a174ab90da37e474f08b7d073433cb60
      patches:
        - patches/patch_libraries_search_prefix.patch
        - patches/0001-Patch-emscripten.patch
        - patches/0002-Create-brotli-lib-dir-before-copy.patch
        # - patches/0003-Use-NewlineBoundaryFinder-for-Emscripten.patch
        - patches/0004-Fix-xxhash-emscripten-extern-C-linkage.patch
        - patches/0005-Fix-FindSnappyAlt-target-type-check.patch
        - patches/0006-Fix-FindBrotliAlt-root-variable.patch
        - patches/0007-Include-FindPackageHandleStandardArgs-in-FindBrotliAlt.patch
        - patches/0008-Fix-FindThriftAlt-missing-target-on-early-return.patch
        - patches/0009-Remove-pthread-from-R-arrow-PKG_LIBS.patch

  requirements:
    build:
      - ${{ compiler("cxx") }}
      - cmake
      - make
      - cross-python_emscripten-wasm32
      - python
      - cython >=3.0.12
      - setuptools
      - setuptools-scm
      - numpy
      - pip

      - cross-r-base_${{ target_platform }}
      - pkg-config
      - r-assertthat
      - r-bit64
      - r-cpp11
      - r-glue
      - r-purrr
      - r-r6
      - r-rlang
      - r-tidyselect
      - r-vctrs
    host:
      - python
      - boost-cpp
      - re2
      - libabseil
      - libutf8proc
      - rapidjson
      - nlohmann_json
      - brotli
      - zlib
      - bZip2
      - lz4-c = 1.10.0
      - protobuf
      - zstd
      - xsimd
      - thrift-cpp = 0.22.0
      - snappy

      - r-assertthat
      - r-bit64
      - r-cpp11
      - r-glue
      - r-purrr
      - r-r6
      - r-rlang
      - r-tidyselect
      - r-vctrs

  build:
    script: build.sh

outputs:
  # ============================================================================
  # Core Arrow C++ Library Outputs
  # ============================================================================
  - package:
      name: arrow-cpp
      version: ${{ version }}
    build:
      script: echo "Collecting files from cache"
      files:
        include:
          - lib/libarrow.a
          - lib/cmake/Arrow/
          - lib/pkgconfig/arrow.pc
          - include/arrow/**
        exclude:
          - include/arrow/acero/**
          - include/arrow/compute/**
          - include/arrow/dataset/**
          - include/arrow/testing/**
    requirements:
      run:
        - boost-cpp
        - re2
        - libabseil
        - libutf8proc
        - rapidjson
        - nlohmann_json
        - brotli
        - zlib
        - bZip2
        - lz4-c = 1.10.0
        - protobuf
        - zstd
        - xsimd
        - thrift-cpp = 0.22.0
        - snappy
    tests:
      - package_contents:
          lib:
            - libarrow.a
          include:
            - arrow/array.h
      - script:
          - bash build_tests.sh arrow-cpp
        requirements:
          build:
            - ${{ compiler("cxx") }}
            - cmake
            - make
        files:
          recipe:
            - build_tests.sh
            - tests/arrow-cpp/

  - package:
      name: arrow-cpp-compute
      version: ${{ version }}
    build:
      script: echo "Collecting files from cache"
      files:
        include:
          - lib/libarrow_compute.a
          - lib/cmake/ArrowCompute/
          - include/arrow/compute/**
    requirements:
      run:
        - arrow-cpp =${{ version }}
    tests:
      - package_contents:
          lib:
            - libarrow_compute.a
      - script:
          - bash build_tests.sh arrow-cpp-compute
        requirements:
          build:
            - ${{ compiler("cxx") }}
            - cmake
            - make
        files:
          recipe:
            - build_tests.sh
            - tests/arrow-cpp-compute/

  - package:
      name: arrow-cpp-acero
      version: ${{ version }}
    build:
      script: echo "Collecting files from cache"
      files:
        include:
          - lib/libarrow_acero.a
          - lib/cmake/ArrowAcero/
          - include/arrow/acero/**
    requirements:
      run:
        - arrow-cpp =${{ version }}
        - arrow-cpp-compute =${{ version }}
    tests:
      - package_contents:
          lib:
            - libarrow_acero.a
      - script:
          - bash build_tests.sh arrow-cpp-acero
        requirements:
          build:
            - ${{ compiler("cxx") }}
            - cmake
            - make
        files:
          recipe:
            - build_tests.sh
            - tests/arrow-cpp-acero/

  - package:
      name: arrow-cpp-dataset
      version: ${{ version }}
    build:
      script: echo "Collecting files from cache"
      files:
        include:
          - lib/libarrow_dataset.a
          - lib/cmake/ArrowDataset/
          - include/arrow/dataset/**
    requirements:
      run:
        - arrow-cpp =${{ version }}
        - arrow-cpp-compute =${{ version }}
        - arrow-cpp-acero =${{ version }}
        - arrow-cpp-parquet =${{ version }}
    tests:
      - package_contents:
          lib:
            - libarrow_dataset.a
      - script:
          - bash build_tests.sh arrow-cpp-dataset
        requirements:
          build:
            - ${{ compiler("cxx") }}
            - cmake
            - make
        files:
          recipe:
            - build_tests.sh
            - tests/arrow-cpp-dataset/

  - package:
      name: arrow-cpp-parquet
      version: ${{ version }}
    build:
      script: echo "Collecting files from cache"
      files:
        - lib/libparquet.a
        - lib/cmake/ArrowParquet/
        - lib/cmake/Parquet/
        - include/parquet/**
    requirements:
      run:
        - arrow-cpp =${{ version }}
    tests:
      - package_contents:
          lib:
            - libparquet.a
      - script:
          - bash build_tests.sh arrow-cpp-parquet
        requirements:
          build:
            - ${{ compiler("cxx") }}
            - cmake
            - make
        files:
          recipe:
            - build_tests.sh
            - tests/arrow-cpp-parquet/

  # ============================================================================
  # Python bindings
  # ============================================================================
  - package:
      name: pyarrow
      version: ${{ version }}
    build:
      script: echo "Collecting files from cache"
      files:
        include:
          - lib/libarrow_python.so
          - lib/python*/site-packages/pyarrow/**/*.py
          - lib/python*/site-packages/pyarrow/**/*.pxd
          - lib/python*/site-packages/pyarrow/**/*.pxi
          - lib/python*/site-packages/pyarrow/**/*.so
        exclude:
        - '**/*.pyc'
        - '**/__pycache__/**'
        - '**.dist-info/**'
        - '**/test_*.py'
      python:
        skip_pyc_compilation:
        - '**/*.py'
    requirements:
      build:
        - ${{ compiler("cxx") }}
        - cross-python_emscripten-wasm32
        - python
        - cython >=3.0.12
        - setuptools
        - setuptools-scm
        - numpy
        - pip
        - cmake
        - make
      host:
        - numpy
        - python
        - cffi
        - arrow-cpp =${{ version }}
        - arrow-cpp-acero =${{ version }}
        - arrow-cpp-dataset =${{ version }}
        - arrow-cpp-parquet =${{ version }}
        - arrow-cpp-compute =${{ version }}
        - re2
        - libabseil
        - libutf8proc
      run:
        - numpy
        - python
        - libffi
        - pycparser
        - cloudpickle
        - fsspec
        - arrow-cpp =${{ version }}
        - arrow-cpp-acero =${{ version }}
        - arrow-cpp-dataset =${{ version }}
        - arrow-cpp-parquet =${{ version }}
        - arrow-cpp-compute =${{ version }}
    tests:
      - script:
          - bash test_pyarrow.sh
        files:
          recipe:
            - test_py_arrow.py
            - test_pyarrow.sh
            - empack_config.yaml
        requirements:
          build:
            - pytester
          run:
            - pytester-run

# ============================================================================
# R bindings
# ============================================================================
  - package:
      name: r-arrow
      version: ${{ version }}
    build:
      script: echo "Collecting files from cache"
      files:
        include:
          - lib/R/library/arrow/libs/arrow.so
          - lib/R/library/arrow/DESCRIPTION
          - lib/R/library/arrow/NAMESPACE
          - lib/R/library/arrow/R/*.R
    requirements:
      
      run:
      - arrow-cpp =${{ version }}
      - arrow-cpp-acero =${{ version }}
      - arrow-cpp-dataset =${{ version }}
      - arrow-cpp-parquet =${{ version }}
      - arrow-cpp-compute =${{ version }}
      - r-assertthat
      - r-bit64
      - r-cpp11
      - r-glue
      - r-purrr
      - r-r6
      - r-rlang
      - r-tidyselect
      - r-vctrs
    tests:
    - package_contents:
        lib:
        - R/library/arrow/libs/arrow.so

about:
  homepage: https://arrow.apache.org/
  license: Apache-2.0
  license_file: LICENSE.txt
  summary: "Arrow: A cross-language development platform for in-memory analytics"
  description: |
    Apache Arrow is a cross-language development platform for in-memory analytics.
    This recipe builds the Arrow C++ library, Python bindings (pyarrow), and R bindings (r-arrow).
  license_family: APACHE

extra:
  recipe-maintainers:
    - Klaim
    - martinRenou
    - DerThorsten
    - Alex-PLACET
    - IsabelParedes
