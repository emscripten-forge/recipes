From 20019c96fafcede07bf7f6650b5327fcace0700c Mon Sep 17 00:00:00 2001
From: Isabel Paredes <isabel.paredes@quantstack.net>
Date: Wed, 12 Nov 2025 09:57:35 +0100
Subject: [PATCH] Update linkage

---
 CMakeLists.txt | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2b26284..d6b261d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -59,6 +59,7 @@ option(XEUS_R_USE_SHARED_XEUS_R "Link xr  with the xeus-r shared library (instea
 option(XEUS_R_EMSCRIPTEN_WASM_BUILD "Build for wasm with emscripten" OFF)
 
 if(EMSCRIPTEN)
+    set_property(GLOBAL PROPERTY TARGET_SUPPORTS_SHARED_LIBS TRUE)
     add_compile_definitions(XEUS_R_EMSCRIPTEN_WASM_BUILD)
     message("Build with emscripten")
     set(XEUS_R_BUILD_STATIC ON)
@@ -84,6 +85,7 @@ if (NOT TARGET xeus AND NOT TARGET xeus-static)
     find_package(xeus ${xeus_REQUIRED_VERSION} REQUIRED)
 endif ()
 find_package(R REQUIRED)
+find_package(ZLIB)
 
 message(STATUS "R_HOME           = ${R_HOME}")
 message(STATUS "R_INCLUDE_DIR    = ${R_INCLUDE_DIR}")
@@ -225,7 +227,7 @@ macro(xeus_r_set_kernel_options target_name)
             target_link_libraries(${target_name} PRIVATE ${CMAKE_DL_LIBS} util)
         endif()
     else ()
-        target_link_libraries(${target_name} PRIVATE xeus-r-static)
+        target_link_libraries(${target_name} PRIVATE xeus-r-static R embind ZLIB::ZLIB pcre2-8 lzma bz2 iconv)
     endif()
 
     if(NOT EMSCRIPTEN)
@@ -271,8 +273,10 @@ macro(xeus_r_create_target target_name linkage output_name)
     endif ()
 
     if (EMSCRIPTEN)
+        link_directories(${R_HOME}/lib)
         target_link_libraries(${target_name} PUBLIC ${XEUS_R_XEUS_TARGET}
-            PRIVATE ${R_LIBRARY_BLAS} ${R_LIBRARY_LAPACK} ${R_LDFLAGS})
+            PRIVATE ${R_LIBRARY_BLAS} ${R_LIBRARY_LAPACK})
+        target_link_options(${target_name} PRIVATE ${R_LDFLAGS})
     else ()
         target_link_libraries(${target_name} PUBLIC ${XEUS_R_XEUS_TARGET} PRIVATE ${R_LIBRARY_BASE})
     endif ()
@@ -341,7 +345,7 @@ if(EMSCRIPTEN)
         PUBLIC "SHELL: --pre-js ${CMAKE_CURRENT_SOURCE_DIR}/wasm_patches/env_vars.js"
         PUBLIC "SHELL: --post-js ${CMAKE_CURRENT_SOURCE_DIR}/wasm_patches/post.js"
         PUBLIC "SHELL: -s ERROR_ON_UNDEFINED_SYMBOLS=1"
-        PUBLIC "SHELL: -s EXPORTED_RUNTIME_METHODS='[\"FS\",\"PATH\",\"LDSO\",\"getDylinkMetadata\",\"loadDynamicLibrary\",\"ERRNO_CODES\"]'"
+        PUBLIC "SHELL: -s EXPORTED_RUNTIME_METHODS='[\"FS\",\"PATH\",\"LDSO\",\"loadDynamicLibrary\",\"ERRNO_CODES\"]'"
     )
 endif()
 
