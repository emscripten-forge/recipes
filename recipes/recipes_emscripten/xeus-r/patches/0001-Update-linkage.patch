From 2bc3552f936a7266c5bd945a9b5cd5904648fde7 Mon Sep 17 00:00:00 2001
From: Isabel Paredes <isabel.paredes@quantstack.net>
Date: Tue, 18 Nov 2025 11:02:26 +0100
Subject: [PATCH] Update linkage

---
 CMakeLists.txt | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2b26284..56130e5 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -59,6 +59,7 @@ option(XEUS_R_USE_SHARED_XEUS_R "Link xr  with the xeus-r shared library (instea
 option(XEUS_R_EMSCRIPTEN_WASM_BUILD "Build for wasm with emscripten" OFF)
 
 if(EMSCRIPTEN)
+    set_property(GLOBAL PROPERTY TARGET_SUPPORTS_SHARED_LIBS TRUE)
     add_compile_definitions(XEUS_R_EMSCRIPTEN_WASM_BUILD)
     message("Build with emscripten")
     set(XEUS_R_BUILD_STATIC ON)
@@ -84,6 +85,7 @@ if (NOT TARGET xeus AND NOT TARGET xeus-static)
     find_package(xeus ${xeus_REQUIRED_VERSION} REQUIRED)
 endif ()
 find_package(R REQUIRED)
+find_package(ZLIB)
 
 message(STATUS "R_HOME           = ${R_HOME}")
 message(STATUS "R_INCLUDE_DIR    = ${R_INCLUDE_DIR}")
@@ -181,7 +183,8 @@ macro(xeus_r_set_common_options target_name)
         CMAKE_CXX_COMPILER_ID MATCHES "Intel")
 
         if (EMSCRIPTEN)
-            target_compile_options(${target_name} PRIVATE -fPIC)
+            target_compile_options(${target_name} PRIVATE -fPIC -fwasm-exceptions)
+            target_link_options(${target_name} PRIVATE -fwasm-exceptions)
         else ()
             target_compile_options(${target_name} PUBLIC -Wunused-parameter -Wextra -Wreorder)
         endif()
@@ -271,8 +274,9 @@ macro(xeus_r_create_target target_name linkage output_name)
     endif ()
 
     if (EMSCRIPTEN)
+        link_directories(${R_HOME}/lib)
         target_link_libraries(${target_name} PUBLIC ${XEUS_R_XEUS_TARGET}
-            PRIVATE ${R_LIBRARY_BLAS} ${R_LIBRARY_LAPACK} ${R_LDFLAGS})
+            PRIVATE ${R_LIBRARY_BLAS} ${R_LIBRARY_LAPACK})
     else ()
         target_link_libraries(${target_name} PUBLIC ${XEUS_R_XEUS_TARGET} PRIVATE ${R_LIBRARY_BASE})
     endif ()
@@ -332,7 +336,7 @@ if(EMSCRIPTEN)
     include(WasmBuildOptions)
     find_package(xeus-lite REQUIRED)
     add_executable(xr src/main_emscripten_kernel.cpp)
-    target_link_libraries(xr PRIVATE xeus-lite)
+    target_link_libraries(xr PRIVATE xeus-lite embind ${R_LIBRARY_BASE})
 
     xeus_r_set_kernel_options(xr)
     xeus_wasm_compile_options(xr)
@@ -341,7 +345,6 @@ if(EMSCRIPTEN)
         PUBLIC "SHELL: --pre-js ${CMAKE_CURRENT_SOURCE_DIR}/wasm_patches/env_vars.js"
         PUBLIC "SHELL: --post-js ${CMAKE_CURRENT_SOURCE_DIR}/wasm_patches/post.js"
         PUBLIC "SHELL: -s ERROR_ON_UNDEFINED_SYMBOLS=1"
-        PUBLIC "SHELL: -s EXPORTED_RUNTIME_METHODS='[\"FS\",\"PATH\",\"LDSO\",\"getDylinkMetadata\",\"loadDynamicLibrary\",\"ERRNO_CODES\"]'"
     )
 endif()
 
